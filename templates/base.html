<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles/style.css') }}">
    <title>VoteFlow</title>
<!--    <link rel="stylesheet" href="{{ url_for('static', filename='styles/bootstrap.min.css') }}">-->
</head>
<body>
<div class="main-window">
    {% block body%}
    {% endblock %}
    <div class="user-name">[{{ user }}]</div>
    <div id="number_state" class="hidden">{{state}}</div>
</div>
<!--    <script src="{{ url_for('static', filename='styles/bootstrap.bundle.min.js') }}"></script>-->
{% block scripts %}
{% endblock %}

<script>
    document.addEventListener('DOMContentLoaded', () => {
  // Находим все смайлики
  const smiles = document.querySelectorAll('.smile');

  // Для каждого смайлика добавляем обработчик клика
  smiles.forEach(smile => {
    smile.addEventListener('click', () => {
      // Добавляем класс анимации
      smile.classList.add('jump');

      // Удаляем класс после завершения анимации
      smile.addEventListener('animationend', () => {
        smile.classList.remove('jump');
      });
    });
  });
});
</script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.getElementById('autoRefreshForm');
        let isAnimating = false;

        // Обработчик клика по кнопке (ваш код, без таймера)
        const button = document.getElementById('button-heart');
        if (button) {
            button.addEventListener('click', function (e) {
                e.preventDefault();
                // if (isAnimating) return;
                // isAnimating = true;

                const heart = document.createElement('div');
                heart.innerHTML = '❤️';
                heart.classList.add('heart');

                const rect = button.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;

                // console.log(x, y);
                heart.style.left = x + 'px';
                heart.style.top = y + 'px';

                button.appendChild(heart);

                setTimeout(() => {
                    heart.remove();
                    // isAnimating = false;
    // Проверяем, есть ли на форме кнопка submit
    const submitButton = form.querySelector('button[type="submit"], input[type="submit"]');
    if (submitButton) {
        form.requestSubmit();
    }
    }, 1500);
            });
        } else {
            console.error('Кнопка #button-heart не найдена');
        }

        // SSE: слушаем серверные обновления
        function initEventSource() {
            const eventSource = new EventSource('/updates');
            const old_number_id = document.getElementById('number_state')
            const old_number = old_number_id.innerText;
            eventSource.onmessage = function (event) {
                // console.log('Новое:', event.data, 'Старое', old_number);
                try {
                    if (event.data != old_number) { // Проверка на значение True
                        location.reload(); // Обновление страницы
                    }
                } catch (e) {
                    console.error('Ошибка парсинга JSON:', e);
                }
            };

            eventSource.onerror = function (err) {
                console.error('Ошибка SSE:', err);
                eventSource.close();
                setTimeout(initEventSource, 3000); // Переподключение
            };
        }

        if (!!window.EventSource) {
            initEventSource();
        } else {
            console.warn('SSE не поддерживается вашим браузером');
        }
    });
</script>
</body>
</html>
