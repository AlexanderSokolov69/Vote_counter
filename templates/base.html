<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles/style.css') }}">
    <title>VoteFlow</title>
</head>
<body>
<div class="main-window">
    {% block body%}
    {% endblock %}
    <div id="number_state">{{state}}</div>
</div>

<script>
    // Функция для обновления позиции всплывающего значения (ваш код)
    function updatePopupPosition(slider, popup) {
        const min = parseFloat(slider.min);
        const max = parseFloat(slider.max);
        const value = parseFloat(slider.value);
        const percent = (value - min) / (max - min) * 100;
        popup.style.left = `calc(${percent}% + (${20 - percent * 0.4}px))`;
        if (slider.id === 'temp-slider') {
            popup.textContent = `${value}°C`;
        } else if (slider.id === 'battery-slider') {
            popup.textContent = `${value}%`;
        } else {
            popup.textContent = value;
        }
    }

    // Инициализация ползунка (ваш код)
    function initSlider(sliderId, popupId, outputId) {
        const slider = document.getElementById(sliderId);
        const popup = document.getElementById(popupId);
        const output = document.getElementById(outputId);

        updatePopupPosition(slider, popup);

        slider.addEventListener('input', () => updatePopupPosition(slider, popup));
        slider.addEventListener('mousedown', () => popup.style.opacity = '1');
        slider.addEventListener('mouseup', () => popup.style.opacity = '0');
        slider.addEventListener('touchstart', () => popup.style.opacity = '1');
        slider.addEventListener('touchend', () => popup.style.opacity = '0');
    }

    // Инициализация ползунков (ваш код)
    document.addEventListener('DOMContentLoaded', () => {
        initSlider('volume-slider', 'volume-popup', 'volume-output');
    });
</script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.getElementById('autoRefreshForm');
        let isAnimating = false;

        // Обработчик клика по кнопке (ваш код, без таймера)
        const button = document.getElementById('button-heart');
        if (button) {
            button.addEventListener('click', function (e) {
                e.preventDefault();
                if (isAnimating) return;
                isAnimating = true;

                const heart = document.createElement('div');
                heart.innerHTML = '❤️';
                heart.classList.add('heart');

                const rect = button.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;

                console.log(x, y);
                heart.style.left = x + 'px';
                heart.style.top = y + 'px';

                button.appendChild(heart);

                setTimeout(() => {
                    heart.remove();
                    isAnimating = false;
                    form.requestSubmit();
                }, 1500);
            });
        } else {
            console.error('Кнопка #button-heart не найдена');
        }

        // SSE: слушаем серверные обновления
        function initEventSource() {
            const eventSource = new EventSource('/updates');
            const old_number_id = document.getElementById('number_state')
            const old_number = old_number_id.innerText;
            eventSource.onmessage = function (event) {
                console.log('Новое:', event.data, 'Старое', old_number);
                try {
                    if (event.data != old_number) { // Проверка на значение True
                        location.reload(); // Обновление страницы
                    }
                } catch (e) {
                    console.error('Ошибка парсинга JSON:', e);
                }
            };

            eventSource.onerror = function (err) {
                console.error('Ошибка SSE:', err);
                eventSource.close();
                setTimeout(initEventSource, 3000); // Переподключение
            };
        }

        if (!!window.EventSource) {
            initEventSource();
        } else {
            console.warn('SSE не поддерживается вашим браузером');
        }
    });
</script>
</body>
</html>
